name: Streamlit App CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.11']  # Python 3.11ë¡œ ë³€ê²½
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    # pip ìºì‹œ ì¶”ê°€ë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        # í…ŒìŠ¤íŠ¸ ë° ê°œë°œ ë„êµ¬ ì„¤ì¹˜
        pip install pytest pytest-cov flake8
    
    - name: Run tests with secrets
      env:
        OC_CODE: ${{ secrets.OC_CODE }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        # tests ë””ë ‰í† ë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸
        if [ -d "tests" ]; then
          echo "Running pytest..."
          python -m pytest tests/ -v --cov=./ --cov-report=xml
        else
          echo "No tests directory found. Creating sample test..."
          # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ìƒì„±
          mkdir -p tests
          cat > tests/test_sample.py << 'EOF'
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

def test_import():
    """ì•±ì´ ì •ìƒì ìœ¼ë¡œ import ë˜ëŠ”ì§€ í™•ì¸"""
    try:
        import streamlit as st
        assert st is not None
        print("âœ… Streamlit import successful")
    except ImportError:
        assert False, "Streamlit import failed"

def test_environment_variables():
    """í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸"""
    oc_code = os.getenv('OC_CODE')
    api_key = os.getenv('OPENAI_API_KEY')
    print(f"âœ… OC_CODE present: {bool(oc_code)}")
    print(f"âœ… OPENAI_API_KEY present: {bool(api_key)}")
    assert True  # í™˜ê²½ë³€ìˆ˜ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
EOF
          python -m pytest tests/ -v
        fi
    
    - name: Check code quality
      run: |
        echo "Running code quality checks..."
        # E9: Python syntax errors
        # F63: Wrong use of operators
        # F7: Syntax error or undefined names
        # F82: Undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
          --exclude=.git,__pycache__,venv,env,.venv \
          --max-line-length=120
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 5

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Streamlit Cloud
      env:
        STREAMLIT_API_TOKEN: ${{ secrets.STREAMLIT_API_TOKEN }}
      run: |
        # Streamlit Cloud ë°°í¬
        if [ -z "$STREAMLIT_API_TOKEN" ]; then
          echo "âš ï¸  STREAMLIT_API_TOKEN not set. Skipping deployment."
          echo "â„¹ï¸  Please add STREAMLIT_API_TOKEN to GitHub Secrets for automatic deployment."
        else
          echo "ğŸš€ Deploying to Streamlit Cloud..."
          # Streamlit CloudëŠ” GitHub ì—°ë™ìœ¼ë¡œ ìë™ ë°°í¬ë˜ë¯€ë¡œ
          # ì¶”ê°€ ì‘ì—…ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— êµ¬í˜„
          echo "âœ… Deployment triggered via GitHub integration"
        fi
