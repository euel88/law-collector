name: Streamlit App CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ë¹Œë“œ ë° ì¢…ì†ì„± í™•ì¸
  build:
    name: Build and Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # pip ìºì‹œë¡œ ë¹Œë“œ ì†ë„ í–¥ìƒ
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ì•±ì´ ì •ìƒì ìœ¼ë¡œ import ë˜ëŠ”ì§€ë§Œ í™•ì¸
    - name: Verify app imports
      env:
        OC_CODE: ${{ secrets.OC_CODE }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python -c "
        import streamlit
        import requests
        import pandas
        import PyPDF2
        import pdfplumber
        print('âœ… All imports successful')
        "
    
    # Streamlit ì•± ë¬¸ë²• ê²€ì‚¬
    - name: Check Streamlit app syntax
      run: |
        python -m py_compile *.py || true
        echo "âœ… Python syntax check completed"

  # Streamlit Cloud ë°°í¬
  deploy:
    name: Deploy to Streamlit Cloud
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy notification
      run: |
        echo "ğŸš€ Deployment triggered for Streamlit Cloud"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "âœ… Streamlit Cloud will automatically deploy via GitHub integration"
        echo "ğŸ“Š Check deployment status at: https://share.streamlit.io/"
